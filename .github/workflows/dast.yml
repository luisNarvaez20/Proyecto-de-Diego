name: DAST Scan - Proyecto DAST

on:
  workflow_call:
    inputs:
      service:
        required: false        # Ahora opcional para evitar errores
        type: string
        default: backend       # Valor por defecto si no se pasa desde main.yml

jobs:
  dast:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      # Instalar dependencias según el servicio
      - name: Install backend dependencies
        if: ${{ inputs.service == 'backend' }}
        run: |
          cd Servicios/back-end_PIS6TO-291358e1d35195c74d4328034fd56025d9795ac5
          npm ci

      - name: Install frontend dependencies
        if: ${{ inputs.service == 'frontend' }}
        run: |
          cd Servicios/front-end_PIS6TO-db594e860f4b1fa1f199237b67f00011c9d31bc0
          npm ci

      # Iniciar servicio según el input
      - name: Start Backend
        if: ${{ inputs.service == 'backend' }}
        run: |
          cd Servicios/back-end_PIS6TO-291358e1d35195c74d4328034fd56025d9795ac5
          nohup npm start &
          sleep 10
          echo "TARGET_URL=http://localhost:8080" >> $GITHUB_ENV

      - name: Start Frontend
        if: ${{ inputs.service == 'frontend' }}
        run: |
          cd Servicios/front-end_PIS6TO-db594e860f4b1fa1f199237b67f00011c9d31bc0
          nohup npm start -- --port 3000 &
          sleep 10
          echo "TARGET_URL=http://localhost:3000" >> $GITHUB_ENV

      # Esperar a que el servicio esté listo
      - name: Wait for app ready
        run: |
          echo "Esperando servicio listo en $TARGET_URL..."
          timeout 120 bash -c 'until curl -s $TARGET_URL > /dev/null; do sleep 5; done'

      # Ejecutar OWASP ZAP
      - name: Run OWASP ZAP
        uses: zaproxy/action-full-scan@v0.11.0
        with:
          docker_name: 'owasp/zap2docker-stable'
          target: ${{ env.TARGET_URL }}
          cmd_options: '-a -j -l WARN -z "-addoninstallall"'
          allow_issue_writing: false

      # Subir reporte
      - name: Upload report
        uses: actions/upload-artifact@v4
        with:
          name: DAST_Report_${{ inputs.service }}.html
          path: report_html.html
