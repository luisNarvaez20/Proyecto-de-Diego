name: 04 SAST

on:
  workflow_dispatch:   # permite ejecución manual
  workflow_call:       # permite que otros workflows lo llamen

jobs:
  SAST-CodeQL:
    name: Build and SAST CodeQL
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: [ "java" ]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4  # ← Actualizado a v4
        with:
          languages: ${{ matrix.language }}

      - name: Set up JDK 11
        uses: actions/setup-java@v4  # ← Actualizado a v4
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: maven

      - name: Build with Maven
        run: mvn clean package -B -Dmaven.test.skip

      - name: Cache build
        id: cache-build
        uses: actions/cache@v4  # ← Actualizado a v4
        with:
          path: target
          key: ${{ runner.os }}-target-${{ hashFiles('**/pom.xml') }}  # ← Mejorado

      - name: Cache m2
        id: cache-deps
        uses: actions/cache@v4  # ← Actualizado a v4
        with:
          path: ~/.m2
          key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}  # ← Mejorado
          restore-keys: |
            ${{ runner.os }}-m2-

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: target
          path: ${{ github.workspace }}/target

      - name: CodeQL Analysis
        uses: github/codeql-action/analyze@v4  # ← Actualizado a v4
        with:
          category: "/language:${{ matrix.language }}"
          # CodeQL ya sube automáticamente los resultados
          # No necesitas upload-sarif adicional

  SpotBugs:
    name: SAST SpotBugs
    needs: [SAST-CodeQL]
    runs-on: ubuntu-latest
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up JDK 11
        uses: actions/setup-java@v4
        with:
          java-version: '11'
          distribution: 'temurin'
          cache: maven

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: target
          path: ./target

      - name: Run SpotBugs
        continue-on-error: true  # ← Por si SpotBugs falla
        run: |
          mvn com.github.spotbugs:spotbugs-maven-plugin:4.8.3.0:spotbugs \
            -Dspotbugs.xmlOutput=true \
            -Dspotbugs.failOnError=false

      - name: Convert SpotBugs to SARIF
        if: always()
        continue-on-error: true
        run: |
          # Instalar herramienta de conversión si es necesario
          # O usar una acción que genere SARIF directamente
          echo "SpotBugs SARIF conversion placeholder"

      - name: Upload SpotBugs Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: spotbugs-results
          path: |
            target/spotbugsXml.xml
            **/spotbugs*.xml

      # Comentado hasta que tengas un SARIF válido de SpotBugs
      # - name: Upload SpotBugs SARIF
      #   if: always()
      #   uses: github/codeql-action/upload-sarif@v4
      #   with:
      #     sarif_file: ${{ github.workspace }}/spotbugs-results.sarif
      #     category: spotbugs